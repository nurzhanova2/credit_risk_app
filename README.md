# Система оценки кредитного риска

Финальный проект по курсу  
**«Программирование для анализа данных и создания баз данных»**

Преподаватель: **Светлана Билощицкая**  

Авторы:  
- **Зарина Нуржанова**  
- **Дана Сатвальдина**  
- **Турар Кайретдинов**

---

## 1. Описание проекта

Цель проекта — разработать прототип **скоринговой системы кредитного риска**, которая:

- анализирует данные о клиенте и параметрах кредита;
- оценивает **вероятность дефолта**;
- классифицирует клиента по уровню риска: **низкий / средний / высокий**;
- предоставляет удобный интерфейс для тестирования отдельных клиентов и пакетной оценки из CSV.

Проект сочетает **анализ данных, построение моделей машинного обучения** и **разработку Python-приложения** для работы с моделями.

---

## 2. Цели и задачи

**Цель:** создать и сравнить несколько моделей оценки кредитного риска и внедрить их в приложении, которое можно использовать для тестирования клиентов.

**Основные задачи:**

1. Провести **исследовательский анализ данных (EDA)**.
2. Выполнить **предобработку данных**:
   - обработка пропусков и выбросов;
   - кодирование категориальных признаков;
   - масштабирование числовых переменных;
   - конструирование новых признаков.
3. Обучить и сравнить несколько моделей:
   - Logistic Regression;
   - Random Forest;
   - XGBoost.
4. Оценить качество моделей (Accuracy, ROC–AUC, F1, Recall по дефолтам).
5. Реализовать **консольное приложение** для прогноза кредитного риска:
   - ввод клиента вручную;
   - загрузка клиентов из CSV;
   - сохранение и просмотр результатов.

---

## 3. Данные

- Размер исходного датасета: **32 581 строк × 12 столбцов**.  
- Целевая переменная: **`loan_status`**  
  - `0` — клиент без дефолта  
  - `1` — клиент в дефолте  

**Примеры признаков:**

- `person_age` — возраст клиента;  
- `person_income` — годовой доход;  
- `person_emp_length` — стаж работы;  
- `loan_amnt` — сумма кредита;  
- `loan_int_rate` — процентная ставка;  
- `loan_percent_income` — доля платежа по кредиту от дохода;  
- `cb_person_cred_hist_length` — длина кредитной истории;  
- категориальные признаки: тип жилья, цель кредита, кредитный рейтинг, факт прошлых дефолтов.

---

## 4. Анализ и подготовка данных (EDA)

**Автор: Дана Сатвалдина**

### 4.1. Пропуски и выбросы

- Пропуски были обнаружены в:
  - `person_emp_length` — 895 пропусков (заполнены модой);
  - `loan_int_rate` — 3116 пропусков (заполнены модой).
- Выбросы по IQR удалены для:
  - `person_age > 75`,
  - `person_income > 500000`,
  - `person_emp_length > 60`.  
  Удалено около **0.2%** строк, данные очищены.

### 4.2. Числовые признаки

- Средний профиль заёмщика:
  - возраст ≈ **27.7** лет;
  - доход ≈ **65 000**;
  - стаж ≈ **4.6** лет;
  - сумма кредита ≈ **9 500**;
  - ставка ≈ **10.7%**;
  - доля кредита от дохода ≈ **0.17**;
  - кредитная история ≈ **5.8** лет.
- Большинство распределений **правосторонне смещены (right-skewed)**.
- Вывод: требуется **нормализация / масштабирование** перед обучением моделей.

### 4.3. Корреляционный анализ

Ключевые наблюдения:

- `person_age` и `cb_person_cred_hist_length`: **положительная корреляция (~0.88)** — старшие клиенты имеют более длинную кредитную историю.
- `loan_amnt` и `loan_percent_income`: **положительная корреляция (~0.58)** — чем больше сумма кредита, тем выше нагрузка.
- `person_income` и `loan_percent_income`: **отрицательная корреляция (~–0.34)** — высокий доход снижает долговую нагрузку.

Отдельно анализировались дефолтные и недефолтные клиенты: у дефолтных клиентов связи с финансовыми показателями выражены сильнее.

### 4.4. Категориальные признаки

Основные выводы:

- Клиенты с жильём в ипотеке (**MORTGAGE**) показывают **наибольшую долю дефолтов (~12.6%)**.
- Владельцы собственного жилья (**OWN**) — **самый низкий риск (~7.5%)**.
- Чем хуже кредитный рейтинг (**grade D–G**), тем выше вероятность дефолта (дефолт до **50–65%** для E–G).
- Клиенты с прошлой просрочкой (**`cb_person_default_on_file = Y`**) имеют риск дефолта около **37.8%**, почти вдвое выше, чем без истории дефолта.

---

## 5. Предобработка данных и Feature Engineering

**Автор: Дана Сатвалдина**

### 5.1. Новые признаки

Были добавлены производные признаки, которые усиливают финансовую интерпретацию:

1. `loan_to_income_ratio` — сумма кредита / доход.
2. `credit_age_ratio` — длина кредитной истории / возраст.
3. `emp_stability_ratio` — стаж / возраст.
4. `debt_capacity_index` — индекс долговой нагрузки (учёт доли дохода и ставки).
5. `financial_experience_index` — интегральный индекс на основе стажа и кредитной истории.
6. `is_home_owner_flg` — наличие собственного жилья.
7. `is_high_risk_grade_flg` — низкий кредитный рейтинг (D, E, F, G).
8. `has_prev_default_flg` — наличие прошлых дефолтов.

### 5.2. Кодирование и нормализация

- Категориальные признаки закодированы с помощью **One-Hot Encoding**.
- Булевы признаки переведены в формат 0/1.
- Числовые признаки масштабированы с помощью **StandardScaler**.
- После всех преобразований сформирован итоговый датасет  
  **`credit_risk_preprocessed.csv`** (~24 признака).

---

## 6. Модель Logistic Regression

**Автор: Дана Сатвалдина**

### 6.1. Обучение

- Разделение данных: **80% train / 20% test**.
- Использовалась стандартная **Logistic Regression** (с масштабированными данными).
- Цель — базовая интерпретируемая модель для анализа влияния признаков.

### 6.2. Качество

- Accuracy ≈ **0.87**.
- Модель хорошо различает клиентов в целом, но:
  - **Recall по дефолтному классу ниже**, чем у ансамблей.

### 6.3. Важность признаков

Положительные коэффициенты (увеличивают риск):

- `loan_grade_D/E/F/G` — низкий кредитный рейтинг.
- `loan_percent_income` — доля кредита от дохода.
- `person_home_ownership_RENT` — арендаторы.
- флаг прошлых дефолтов.

Отрицательные коэффициенты (снижают риск):

- `person_home_ownership_OWN` — собственное жильё.
- Некоторые цели кредита (`VENTURE`, `EDUCATION`).
- Более высокие доходы и небольшие суммы кредита.

**Вывод:** Logistic Regression хорошо подходит для **интерпретации**, но уступает ансамблям по качеству детекции дефолтов.

---

## 7. Random Forest

**Автор: Зарина Нуржанова**

### 7.1. Обучение и подбор гиперпараметров

- Использовалась модель **RandomForestClassifier**.
- Подбор параметров через **GridSearchCV**:
  - число деревьев,
  - максимальная глубина,
  - минимальное число объектов в листе и др.

### 7.2. Качество

- Accuracy ≈ **0.9320**  
- ROC–AUC ≈ **0.9319**
- Высокая точность по классу 0 и уверенное качество по классу 1.

### 7.3. Интерпретация

- Важные признаки:
  - долговая нагрузка (доля кредита от дохода, ставка, сумма кредита),
  - доход,
  - стаж, кредитная история,
  - тип жилья и прошлые дефолты.
- Модель хорошо отражает **финансовую логику** скоринга.

---

## 8. XGBoost и итоговый анализ

**Автор: Турар Кайретдинов**

### 8.1. Базовая модель XGBoost

- Разделение: **80% train / 20% test** (стратифицированно по `loan_status`).
- Базовый XGBoost показал:
  - Accuracy ≈ **0.9323**
  - ROC–AUC ≈ **0.9449**
  - F1 по дефолтному классу ≈ **0.82**
  - Recall по дефолтам ≈ **0.72**

### 8.2. Подбор гиперпараметров (RandomizedSearchCV)

- Подбирались:
  - `n_estimators`, `max_depth`, `learning_rate`,
  - `subsample`, `colsample_bytree`,
  - `min_child_weight`, `gamma`,
  - `reg_alpha`, `reg_lambda`.
- Лучший ROC–AUC на кросс-валидации ≈ **0.9434**.

### 8.3. Лучшая модель XGBoost

После настройки:

- Accuracy: **0.9345**
- ROC–AUC: **0.9502**
- Класс 1 (дефолт):
  - precision ≈ **0.96**
  - recall ≈ **0.73**
  - f1-score ≈ **0.83**

Confusion matrix (примерно):

- TN ≈ 5054 — надёжные клиенты, правильно классифицированы;
- FP ≈ 41 — хорошие клиенты, ошибочно посчитаны рискованными;
- FN ≈ 386 — дефолты, которые модель пропустила;
- TP ≈ 1036 — дефолты, корректно выявленные моделью.

**Вывод:** XGBoost:

- минимизирует ошибки на «хороших» клиентах;
- уверенно ловит большую часть дефолтов;
- демонстрирует **лучший ROC–AUC** среди всех моделей.

---

## 9. Сравнение моделей

| Модель               | Accuracy | ROC–AUC | Особенности                                               |
|----------------------|----------|---------|-----------------------------------------------------------|
| Logistic Regression  | ~0.87    | ниже    | Интерпретируемая, базовая, слабее по Recall дефолтов     |
| Random Forest        | 0.9320   | 0.9319  | Улавливает нелинейности, высокая точность                |
| **XGBoost (best)**   | **0.9345** | **0.9502** | Лучшее ранжирование по риску, лучший Recall по дефолту |

**Итог:** модель **XGBoost** выбрана как **основная скоринговая модель**,  
Logistic Regression — как **интерпретируемая базовая модель**,  
Random Forest — как промежуточный и подтверждающий результат ансамблевый метод.

---

## 10. Приложение для оценки кредитного риска

В корне проекта реализовано **консольное Python-приложение**, которое:

- загружает обученные модели (`.pkl`);
- позволяет:
  - **вводить данные одного клиента вручную**;
  - **загружать CSV с несколькими клиентами**;
  - **сохранять результаты в файл** и просматривать последние записи.

Пример сценариев:

1. Ввести клиента вручную → получить:
   - вероятность дефолта по каждой модели;
   - уровень риска (низкий / средний / высокий).
2. Загрузить `data/examples/*.csv` с примерами клиентов:
   - низкий риск;
   - средний риск;
   - высокий риск.

---


